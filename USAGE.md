# Locate Service Usage

## Revision History

| Version  | Date       |  Major Changes  |
|----------|------------|-----------------|
| v2beta1  | 2020-05-11 | initial version |

## Introduction

The M-Lab Locate Service is a GCP hosted service that "locates" the best
M-Lab server for a user request. For different use cases, "best" could mean
different things. The sections below provide an overview of the locate
service operations and describe currently supported queries in more detail.

### Locate Nearby Servers

#### Overview

For the `/v2beta1/query` resource, "best" means "geographically close" to the
client. GCP automatically adds client latitude and latitude to the [HTTP
request headers][headers]. The locate service uses this location to search
for nearby M-Lab servers that satisfy the client query.

[headers]: https://cloud.google.com/load-balancing/docs/user-defined-request-headers#how_user-defined_request_headers_work

The locate service also considers:

* is the target server online? (required)
* is the client request frequency consistent with acceptable usage? (required)
* is the target server in the same country as the client? (biased)

The locate service returns up to four results for the requested measurement
service. If not all servers are healthy in a geographic region, then the
locate service may return fewer results. If no servers are available, then
the locate service will return an `Error` and a recommended `NextRequest`
time.

#### Usage

The base locate URL for the locate service nearby query API:

    http://locate.measurementlab.net/v2beta1/query/

Well formed requests must also specify a service name. For example:

* ndt/ndt5 - NDT5 protocol for the NDT measurement service.
* ndt/ndt7 - NDT7 protocol for the NDT measurement service.

The complete locate query request with a service name for "ndt/ndt7" looks like:

    http://locate.measurementlab.net/v2beta1/query/ndt/ndt7

A successful response will include a list of results. Each result object
includes the machine name and a map of "urls"; the key is the URL template
and the value is the complete URL. The template keys are static so clients
can extract the value.

The complete URL includes the protocol scheme, e.g. "wss", the machien name,
the resource path, and request parameters generated by the locate service.
The `access_token=` request parameter is validated by the target service. An
invalid access token will always be rejected.

    {
      "results": [
        {
          "machine": "mlab3-lga05.mlab-oti.measurement-lab.org",
          "urls": {
            "ws:///ndt/v7/download": "ws://ndt-mlab3-lga05.mlab-oti.measurement-lab.org/ndt/v7/download?access_token={{TOKEN}}",
            "ws:///ndt/v7/upload": "ws://ndt-mlab3-lga05.mlab-oti.measurement-lab.org/ndt/v7/upload?access_token={{TOKEN}}",
            "wss:///ndt/v7/download": "wss://ndt-mlab3-lga05.mlab-oti.measurement-lab.org/ndt/v7/download?access_token={{TOKEN}}",
            "wss:///ndt/v7/upload": "wss://ndt-mlab3-lga05.mlab-oti.measurement-lab.org/ndt/v7/upload?access_token={{TOKEN}}",
          }
        },
        ...
      ]
    }

The target server makes the final call for whether to accept or reject a
connection. For example, the server may reject a valid access token request
if the server is overloaded and the measurement quality would be too low.
Clients should be prepared for a connection to be rejected and try the next
result. If all target servers reject the client request, then the platform is
under severe load. And, clients should report the outage to users before
trying again.

> PLANNED(v2): to make retry logic in clients simpler and to incentivise best
practices for using the API, the [v2.QueryResult.NextRequest][nextRequest]
will include a preformatted URL for scheduling the next request to the locate
API. See the [request priority hierarchy][priority].

[nextRequest]: https://godoc.org/github.com/m-lab/locate/api/v2#QueryResult
[priority]: https://godoc.org/github.com/m-lab/locate/api/v2
